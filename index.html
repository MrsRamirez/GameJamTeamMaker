<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Jam Team Shuffler (Kahoot XLSX Supported)</title>

  <!-- XLSX parser (SheetJS). If CDN blocked, host locally and change this to ./libs/xlsx.full.min.js -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg-0:#0b0612; --bg-1:#12081f;
      --card:rgba(255,255,255,0.06);
      --card-2:rgba(255,255,255,0.09);
      --border:rgba(255,255,255,0.14);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.72);
      --good:rgba(34,197,94,0.18);
      --warn:rgba(245,158,11,0.18);
      --err:rgba(239,68,68,0.18);
      --shadow:0 12px 30px rgba(0,0,0,0.35);

      --col-blue: rgba(59,130,246,0.12);
      --col-yellow: rgba(245,158,11,0.12);
      --col-green: rgba(34,197,94,0.12);
    }

    *{box-sizing:border-box;}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1100px 600px at 20% 10%, rgba(192,38,211,0.22), transparent 60%),
        radial-gradient(900px 520px at 80% 20%, rgba(124,58,237,0.22), transparent 60%),
        radial-gradient(900px 520px at 50% 90%, rgba(251,113,133,0.14), transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      min-height:100vh;
    }

    .container{max-width:1200px;margin:0 auto;padding:22px 18px 40px;}
    header{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;margin-bottom:14px;}
    h1{margin:0 0 8px;font-size:clamp(22px,3.2vw,34px);letter-spacing:-0.02em;line-height:1.05;}
    .subtitle{margin-top:6px;color:var(--muted);font-size:14px;max-width:90ch;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;
      border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,0.06);
      box-shadow:var(--shadow);font-size:13px;color:var(--muted);white-space:nowrap;
    }
    .badge b{color:var(--text);font-weight:650;}

    .card{
      background:var(--card);border:1px solid var(--border);border-radius:16px;
      padding:14px;box-shadow:var(--shadow);backdrop-filter:blur(8px);
    }
    .card h2{margin:0 0 8px;font-size:16px;letter-spacing:-0.01em;}
    .muted{color:var(--muted);font-size:13px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;}
    @media (max-width:980px){.row{grid-template-columns:1fr;}}

    textarea{
      width:100%;height:190px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,0.25);color:var(--text);padding:12px;outline:none;
    }

    input[type="text"], input[type="number"], select, input[type="file"]{
      border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,0.22);color:var(--text);
      padding:9px 10px;outline:none;min-height:38px;
      max-width: 100%;
    }

    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;
    }
    .controls > div{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      min-width: 220px;
    }

    button{
      border:1px solid rgba(255,255,255,0.16);
      background:linear-gradient(135deg, rgba(192,38,211,0.92), rgba(124,58,237,0.92));
      color:white;border-radius:12px;padding:9px 12px;cursor:pointer;font-weight:650;
      letter-spacing:0.01em;box-shadow:0 10px 18px rgba(0,0,0,0.25);
      transition:transform 0.05s ease, filter 0.2s ease;
    }
    button:hover{filter:brightness(1.07);}
    button:active{transform:translateY(1px);}
    button.secondary{background:rgba(255,255,255,0.07);color:var(--text);}

    .status{margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:rgba(255,255,255,0.06);font-size:12px;color:var(--muted);
    }
    .pill.ok{background:var(--good);}
    .pill.warn{background:var(--warn);}
    .pill.err{background:var(--err);}

    table{
      width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;overflow:hidden;
      border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,0.18);
    }
    th, td{padding:9px 10px;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.09);}
    th{
      text-align:left;color:rgba(255,255,255,0.88);background:rgba(255,255,255,0.06);
      font-weight:750;position:sticky;top:0;z-index:1;
    }
    tr:last-child td{border-bottom:none;}

    .teams-table th:nth-child(2), .teams-table td:nth-child(2){ background: var(--col-blue); }
    .teams-table th:nth-child(3), .teams-table td:nth-child(3){ background: var(--col-yellow); }
    .teams-table th:nth-child(4), .teams-table td:nth-child(4){ background: var(--col-green); }

    .small-note{
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05);
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>Game Jam Team Shuffler</h1>
        <div class="subtitle">
          Upload <b>Kahoot XLSX</b> or paste <b>CSV</b>. Kahoot blend:
          <b>score = (accuracy × 10) + speed_bonus</b> (fallback to Total Score if Accuracy is missing).
        </div>
      </div>
      <div class="badge">
        <span>Team formula:</span>
        <b>Leader + Designer + Builder</b>
      </div>
    </header>

    <div class="row">
      <!-- INPUT -->
      <div class="card">
        <h2>1) Load Results</h2>

        <div class="controls">
          <div>
            <label for="fileAny"><b>Choose file:</b></label>
            <input id="fileAny" type="file"
                   accept=".csv,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv"/>
          </div>
          <div>
            <button class="secondary" id="loadSample">Load Sample (90 CSV)</button>
            <button class="secondary" id="clearAll">Clear</button>
          </div>
        </div>

        <div class="small-note">
          There is no “Upload” button. Selecting a file loads it automatically.
          If your dropdowns show only “(auto)”, the page did not detect headers—this version uses stronger header detection.
        </div>

        <div class="controls" style="margin-top:12px;">
          <div>
            <label><b>Split mode:</b></label>
            <select id="splitMode">
              <option value="fixed30">Fixed 30 / 30 / 30</option>
              <option value="thirds">Automatic thirds</option>
            </select>
          </div>

          <div>
            <label><b>Seed (optional):</b></label>
            <input id="seedInput" type="text" placeholder="e.g., March6_2026"/>
          </div>

          <div>
            <label><b>Max teams:</b></label>
            <input id="maxTeams" type="number" min="1" max="60" value="30" style="width:92px;"/>
          </div>
        </div>

        <!-- Kahoot mapping -->
        <div class="controls" style="margin-top:10px;">
          <div>
            <label><b>Name column:</b></label>
            <select id="colName"><option value="">(auto)</option></select>
          </div>
          <div>
            <label><b>Total score:</b></label>
            <select id="colTotal"><option value="">(auto)</option></select>
          </div>
          <div>
            <label><b>Accuracy:</b></label>
            <select id="colAccuracy"><option value="">(auto)</option></select>
          </div>
          <div>
            <label><b>Speed bonus:</b></label>
            <select id="colSpeed"><option value="">(auto)</option></select>
          </div>
        </div>

        <p class="muted" style="margin:10px 0 6px;">
          Or paste CSV: required headers are <span class="mono">name</span>, <span class="mono">score</span>.
        </p>
        <textarea id="csvInput" placeholder="name,score
Jane Doe,18
John Smith,12"></textarea>

        <div class="controls">
          <button id="assignRolesBtn">Assign Roles</button>
          <button id="shuffleBtn">Shuffle Roles</button>
          <button id="makeTeamsBtn">Build Teams</button>
        </div>

        <div class="status" id="status">
          <span class="pill warn">Choose a Kahoot XLSX or paste CSV, then click Assign Roles.</span>
        </div>
      </div>

      <!-- TEAMS -->
      <div class="card">
        <h2>2) Teams</h2>
        <div class="muted">
          Teams generated as: <b>Leader + Designer + Builder</b>. Extras remain unassigned.
        </div>

        <div class="controls" style="margin-top:10px;">
          <button id="exportCsvBtn">Export Teams CSV</button>
          <button id="copyTeamsBtn" class="secondary">Copy Teams</button>
        </div>

        <div id="teamsWrap"></div>
        <div id="extrasWrap" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- ROSTER -->
    <div class="card" style="margin-top:16px;">
      <h2>Roster</h2>
      <div id="summary" class="muted">No roster yet.</div>
      <div id="rosterWrap"></div>
    </div>
  </div>

<script>
  // ========= DOM =========
  const fileAny = document.getElementById('fileAny');
  const csvInput = document.getElementById('csvInput');
  const splitMode = document.getElementById('splitMode');
  const seedInput = document.getElementById('seedInput');
  const maxTeamsInput = document.getElementById('maxTeams');

  const colName = document.getElementById('colName');
  const colTotal = document.getElementById('colTotal');
  const colAccuracy = document.getElementById('colAccuracy');
  const colSpeed = document.getElementById('colSpeed');

  const statusEl = document.getElementById('status');
  const summaryEl = document.getElementById('summary');
  const rosterWrap = document.getElementById('rosterWrap');
  const teamsWrap = document.getElementById('teamsWrap');
  const extrasWrap = document.getElementById('extrasWrap');

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function setStatus(msg, kind){
    const cls = kind === 'ok' ? 'ok' : (kind === 'err' ? 'err' : 'warn');
    statusEl.innerHTML = `<span class="pill ${cls}">${escapeHtml(msg)}</span>`;
  }

  function ensureXLSXLoaded(){
    if (typeof XLSX === "undefined") {
      setStatus("XLSX library did not load. Your network may block the CDN. Host xlsx.full.min.js locally in your repo.", "err");
      return false;
    }
    return true;
  }

  // ========= Numbers =========
  function toNumberSafe(v){
    if (v === null || v === undefined) return null;
    const s = String(v).trim();
    if (!s) return null;

    const pctMatch = s.match(/^(\d+(\.\d+)?)\s*%$/);
    if (pctMatch) return Number(pctMatch[1]);

    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  // ========= CSV =========
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let field = '';
    let inQuotes = false;

    function endField(){ row.push(field); field=''; }
    function endRow(){
      if (row.length === 1 && row[0].trim() === '') { row = []; return; }
      rows.push(row); row=[];
    }

    for (let i=0; i<text.length; i++){
      const c = text[i];
      if (c === '"'){
        if (inQuotes && text[i+1] === '"'){ field += '"'; i++; continue; }
        inQuotes = !inQuotes; continue;
      }
      if (!inQuotes && c === ','){ endField(); continue; }
      if (!inQuotes && c === '\n'){ endField(); endRow(); continue; }
      if (!inQuotes && c === '\r'){ continue; }
      field += c;
    }
    endField(); endRow();

    if (!rows.length) return { headers: [], data: [] };

    const headers = rows[0].map(h => (h || '').trim().toLowerCase());
    const data = rows.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (r[idx] ?? '').trim());
      return obj;
    });
    return { headers, data };
  }

  // ========= Seeded shuffle =========
  function seedToUint32(seedStr){
    if (!seedStr) return null;
    let h = 2166136261;
    for (let i=0; i<seedStr.length; i++){
      h ^= seedStr.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  function shuffleInPlace(arr, rng){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(rng() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // ========= Downloads / clipboard =========
  function downloadText(filename, text){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  async function copyToClipboard(text){
    await navigator.clipboard.writeText(text);
  }
  function csvCell(v){
    const s = String(v ?? '');
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  // ========= XLSX header detection (STRONGER) =========
  function normKey(s){
    return String(s || '').trim().toLowerCase().replace(/\s+/g,' ');
  }

  function autoPick(headers, candidates){
    const normalized = headers.map(h => ({ raw:h, n:normKey(h) }));
    for (const cand of candidates){
      const c = cand.toLowerCase();
      const found = normalized.find(h => h.n.includes(c));
      if (found) return found.raw;
    }
    return '';
  }

  // SAFER: populate selects using DOM (not innerHTML)
  function fillMappingDropdowns(headers){
    const selects = [colName, colTotal, colAccuracy, colSpeed];
    for (const sel of selects){
      const keep = sel.value;
      sel.textContent = '';
      const optAuto = document.createElement('option');
      optAuto.value = '';
      optAuto.textContent = '(auto)';
      sel.appendChild(optAuto);

      for (const h of headers){
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = h;
        sel.appendChild(opt);
      }
      if (keep && headers.includes(keep)) sel.value = keep;
      else sel.value = '';
    }
  }

  // Even stronger: finds header row by:
  // 1) candidate match count, then
  // 2) number of non-empty cells
  async function parseKahootXLSX(file){
    if (!ensureXLSXLoaded()) return { headers: [], rows: [] };

    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });

    // Kahoot is usually first sheet; if not, we still try first.
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];

    const grid = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
    if (!grid.length) return { headers: [], rows: [] };

    const headerCandidates = [
      "player","nickname","name",
      "total score","total","score","points",
      "accuracy","accuracy %","correct","correct answers",
      "speed bonus","speed","bonus",
      "rank","position"
    ];

    let bestIdx = -1;
    let bestCandidateHits = -1;
    let bestNonEmpty = -1;

    const scanLimit = Math.min(grid.length, 60);
    for (let i = 0; i < scanLimit; i++){
      const row = grid[i].map(c => String(c || "").trim());
      const rowLower = row.map(c => c.toLowerCase());

      const nonEmpty = rowLower.filter(Boolean).length;
      if (nonEmpty < 2) continue;

      let hits = 0;
      for (const cell of rowLower){
        for (const cand of headerCandidates){
          if (cell.includes(cand)) hits++;
        }
      }

      // primary: candidate hits, secondary: non-empty count
      if (hits > bestCandidateHits || (hits === bestCandidateHits && nonEmpty > bestNonEmpty)){
        bestCandidateHits = hits;
        bestNonEmpty = nonEmpty;
        bestIdx = i;
      }
    }

    // If no candidate hits at all, fall back to the row with the most non-empty cells
    if (bestCandidateHits <= 0){
      bestIdx = -1;
      bestNonEmpty = -1;
      for (let i = 0; i < scanLimit; i++){
        const nonEmpty = grid[i].map(c => String(c || "").trim()).filter(Boolean).length;
        if (nonEmpty > bestNonEmpty){
          bestNonEmpty = nonEmpty;
          bestIdx = i;
        }
      }
    }

    if (bestIdx < 0) bestIdx = 0;

    const headers = grid[bestIdx].map(h => String(h || "").trim()).filter(Boolean);
    if (!headers.length) return { headers: [], rows: [] };

    const rows = [];
    for (let r = bestIdx + 1; r < grid.length; r++){
      const row = grid[r];
      if (!row || !row.some(v => String(v || "").trim() !== "")) continue;

      const obj = {};
      headers.forEach((h, idx) => obj[h] = (row[idx] !== undefined ? row[idx] : ""));
      rows.push(obj);
    }

    return { headers, rows };
  }

  function computeBlendedScore(row, nameKey, totalKey, accKey, speedKey){
    const name = String(row[nameKey] ?? '').trim();
    if (!name) return null;

    const total = totalKey ? toNumberSafe(row[totalKey]) : null;

    let acc = accKey ? toNumberSafe(row[accKey]) : null;
    if (acc !== null && acc > 0 && acc <= 1) acc = acc * 100;

    const speed = speedKey ? toNumberSafe(row[speedKey]) : null;

    let score = null;
    let note = '';

    if (acc !== null){
      score = (acc * 10) + (speed !== null ? speed : 0);
      note = `accuracy(${acc})×10 + speed_bonus(${speed !== null ? speed : 0})`;
    } else if (total !== null){
      score = total;
      note = `total_score(${total})`;
    } else {
      return null;
    }

    return { name, score, note };
  }

  // ========= State =========
  let uploadedRows = [];
  let uploadedHeaders = [];

  let roster = [];
  let tiers = { top: [], mid: [], bot: [], extra: [] };
  let teams = [];

  // ========= Tiering =========
  function buildTiersFromRoster(){
    tiers = { top: [], mid: [], bot: [], extra: [] };
    const n = roster.length;

    if (splitMode.value === 'fixed30'){
      tiers.top = roster.slice(0, 30);
      tiers.mid = roster.slice(30, 60);
      tiers.bot = roster.slice(60, 90);
      tiers.extra = roster.slice(90);
      return;
    }

    const base = Math.floor(n / 3);
    const remainder = n - base * 3;
    const topSize = base + (remainder >= 1 ? 1 : 0);
    const midSize = base + (remainder >= 2 ? 1 : 0);
    const botSize = base;

    tiers.top = roster.slice(0, topSize);
    tiers.mid = roster.slice(topSize, topSize + midSize);
    tiers.bot = roster.slice(topSize + midSize, topSize + midSize + botSize);
    tiers.extra = roster.slice(topSize + midSize + botSize);
  }

  // ========= Rendering =========
  function renderRoster(){
    if (!roster.length){
      summaryEl.textContent = 'No roster yet.';
      rosterWrap.innerHTML = '<p class="muted">Choose a Kahoot XLSX or paste CSV, then click Assign Roles.</p>';
      return;
    }

    const possibleTeams = Math.min(tiers.top.length, tiers.mid.length, tiers.bot.length);
    summaryEl.innerHTML = `
      Students loaded: <b>${roster.length}</b> |
      Leaders: <b>${tiers.top.length}</b>,
      Designers: <b>${tiers.mid.length}</b>,
      Builders: <b>${tiers.bot.length}</b>,
      Extra: <b>${tiers.extra.length}</b> |
      Possible teams: <b>${possibleTeams}</b>
    `;

    const rows = roster.slice(0, 200).map(s => `
      <tr>
        <td>${escapeHtml(s.name)}</td>
        <td>${Number.isFinite(s.score) ? s.score : ''}</td>
        <td>${escapeHtml(s.role || '')}</td>
        <td class="muted">${escapeHtml(s.score_note || '')}</td>
      </tr>
    `).join('');

    rosterWrap.innerHTML = `
      <table>
        <thead><tr><th>Name</th><th>Score</th><th>Role</th><th class="muted">Score source</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="muted">Showing first 200 students.</div>
    `;
  }

  function renderTeams(){
    if (!teams.length){
      teamsWrap.innerHTML = '<p class="muted">No teams yet. Click Shuffle Roles (optional) then Build Teams.</p>';
      extrasWrap.innerHTML = '';
      return;
    }

    const rows = teams.map(t => `
      <tr>
        <td>${t.team}</td>
        <td>${escapeHtml(t.leader.name)}</td>
        <td>${escapeHtml(t.designer.name)}</td>
        <td>${escapeHtml(t.builder.name)}</td>
      </tr>
    `).join('');

    teamsWrap.innerHTML = `
      <table class="teams-table">
        <thead><tr><th>Team</th><th>Leader</th><th>Designer</th><th>Builder</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    const teamCount = teams.length;
    const unassigned = [
      ...tiers.top.slice(teamCount).map(s => ({name:s.name, role:'Leader'})),
      ...tiers.mid.slice(teamCount).map(s => ({name:s.name, role:'Designer'})),
      ...tiers.bot.slice(teamCount).map(s => ({name:s.name, role:'Builder'})),
      ...tiers.extra.map(s => ({name:s.name, role:'Extra'}))
    ];

    if (!unassigned.length){
      extrasWrap.innerHTML = `<div class="muted"><b>Unassigned:</b> none</div>`;
    } else {
      const list = unassigned.slice(0, 60).map(s =>
        `<li>${escapeHtml(s.name)} <span class="pill">${escapeHtml(s.role)}</span></li>`
      ).join('');
      extrasWrap.innerHTML = `
        <div class="muted"><b>Unassigned students:</b> ${unassigned.length} (showing up to 60)</div>
        <ul>${list}</ul>
      `;
    }
  }

  // ========= Actions =========
  async function loadFile(file){
    const ext = (file.name.split('.').pop() || '').toLowerCase();

    if (ext === 'xlsx' || ext === 'xls'){
      const parsed = await parseKahootXLSX(file);
      uploadedHeaders = parsed.headers;
      uploadedRows = parsed.rows;

      fillMappingDropdowns(uploadedHeaders);

      // Set default guesses (but allow override)
      if (!colName.value) colName.value = autoPick(uploadedHeaders, ['player','nickname','name']);
      if (!colTotal.value) colTotal.value = autoPick(uploadedHeaders, ['total score','total','score','points']);
      if (!colAccuracy.value) colAccuracy.value = autoPick(uploadedHeaders, ['accuracy','correct']);
      if (!colSpeed.value) colSpeed.value = autoPick(uploadedHeaders, ['speed bonus','speed','bonus']);

      if (!uploadedHeaders.length){
        setStatus(`XLSX read failed: no headers found. Try re-exporting from Kahoot.`, 'err');
        return;
      }

      if (!uploadedRows.length){
        setStatus(`XLSX loaded, headers found (${uploadedHeaders.length}), but 0 data rows. This usually means Kahoot has a summary sheet format.`, 'err');
        return;
      }

      setStatus(`Loaded XLSX: ${file.name}. headers=${uploadedHeaders.length}, rows=${uploadedRows.length}. Click Assign Roles.`, 'ok');
      return;
    }

    if (ext === 'csv'){
      const text = await file.text();
      csvInput.value = text;
      setStatus(`Loaded CSV: ${file.name}. Click Assign Roles.`, 'ok');
      return;
    }

    setStatus('Unsupported file type. Upload .xlsx/.xls or .csv', 'err');
  }

  function assignRoles(){
    let cleaned = [];
    let uid = 1;

    // Prefer XLSX if present
    if (uploadedRows.length && uploadedHeaders.length){
      const nameKey = colName.value || autoPick(uploadedHeaders, ['player','nickname','name']);
      const totalKey = colTotal.value || autoPick(uploadedHeaders, ['total score','total','score','points']);
      const accKey = colAccuracy.value || autoPick(uploadedHeaders, ['accuracy','correct']);
      const speedKey = colSpeed.value || autoPick(uploadedHeaders, ['speed bonus','speed','bonus']);

      if (!nameKey){
        setStatus('Please pick the correct Name column (Player/Nickname/etc.).', 'err');
        return;
      }

      for (const r of uploadedRows){
        const out = computeBlendedScore(r, nameKey, totalKey, accKey, speedKey);
        if (!out) continue;
        cleaned.push({ __uid: uid++, name: out.name, score: out.score, role:'', score_note: out.note });
      }

      if (cleaned.length < 3){
        setStatus('Not enough usable rows from Kahoot. Try selecting different score columns.', 'err');
        return;
      }

      cleaned.sort((a,b) => (b.score - a.score) || a.name.localeCompare(b.name));
      roster = cleaned;

      buildTiersFromRoster();
      tiers.top.forEach(s => s.role = 'Leader');
      tiers.mid.forEach(s => s.role = 'Designer');
      tiers.bot.forEach(s => s.role = 'Builder');
      tiers.extra.forEach(s => s.role = 'Extra');

      teams = [];
      renderRoster();
      renderTeams();

      setStatus(`Assigned roles from Kahoot for ${roster.length} students.`, 'ok');
      return;
    }

    // CSV fallback
    const { headers, data } = parseCSV(csvInput.value || '');
    if (!headers.includes('name') || !headers.includes('score')){
      setStatus('CSV must include headers: name, score.', 'err');
      return;
    }

    for (const d of data){
      const name = (d.name || '').trim();
      const score = toNumberSafe(d.score);
      if (!name || score === null) continue;
      cleaned.push({ __uid: uid++, name, score, role:'', score_note:'csv(score)' });
    }

    if (cleaned.length < 3){
      setStatus('Need at least 3 valid rows with name + numeric score.', 'err');
      return;
    }

    cleaned.sort((a,b) => (b.score - a.score) || a.name.localeCompare(b.name));
    roster = cleaned;

    buildTiersFromRoster();
    tiers.top.forEach(s => s.role = 'Leader');
    tiers.mid.forEach(s => s.role = 'Designer');
    tiers.bot.forEach(s => s.role = 'Builder');
    tiers.extra.forEach(s => s.role = 'Extra');

    teams = [];
    renderRoster();
    renderTeams();

    setStatus(`Assigned roles from CSV for ${roster.length} students.`, 'ok');
  }

  function shuffleRoles(){
    if (!roster.length){ setStatus('Assign roles first.', 'warn'); return; }

    buildTiersFromRoster();
    const seed = seedToUint32(seedInput.value.trim());
    const rng = seed === null ? Math.random : mulberry32(seed);

    shuffleInPlace(tiers.top, rng);
    shuffleInPlace(tiers.mid, rng);
    shuffleInPlace(tiers.bot, rng);

    tiers.top.forEach(s => s.role = 'Leader');
    tiers.mid.forEach(s => s.role = 'Designer');
    tiers.bot.forEach(s => s.role = 'Builder');
    tiers.extra.forEach(s => s.role = 'Extra');

    teams = [];
    renderRoster();
    renderTeams();
    setStatus('Shuffled within roles. Click Build Teams.', 'ok');
  }

  function buildTeams(){
    if (!roster.length){ setStatus('Assign roles first.', 'warn'); return; }

    const possibleTeams = Math.min(tiers.top.length, tiers.mid.length, tiers.bot.length);
    const maxTeams = Math.max(1, Math.min(Number(maxTeamsInput.value || 30), 60));
    const teamCount = Math.min(possibleTeams, maxTeams);

    if (teamCount < 1){
      setStatus('Not enough students in roles to form teams.', 'err');
      teams = [];
      renderTeams();
      return;
    }

    teams = [];
    for (let i=0; i<teamCount; i++){
      teams.push({ team: i+1, leader: tiers.top[i], designer: tiers.mid[i], builder: tiers.bot[i] });
    }

    renderTeams();
    setStatus(`Built ${teams.length} teams.`, 'ok');
  }

  function exportTeamsCSV(){
    if (!teams.length){ setStatus('Build teams first.', 'warn'); return; }
    const lines = ['team,leader,designer,builder'];
    for (const t of teams){
      lines.push([t.team, csvCell(t.leader.name), csvCell(t.designer.name), csvCell(t.builder.name)].join(','));
    }
    downloadText('gamejam_teams.csv', lines.join('\n'));
    setStatus('Exported teams CSV.', 'ok');
  }

  async function copyTeams(){
    if (!teams.length){ setStatus('Build teams first.', 'warn'); return; }
    const text = teams.map(t => `Team ${t.team}: ${t.leader.name} | ${t.designer.name} | ${t.builder.name}`).join('\n');
    try{ await copyToClipboard(text); setStatus('Copied teams to clipboard.', 'ok'); }
    catch { setStatus('Could not copy (browser permission). Use Export Teams CSV.', 'warn'); }
  }

  function clearAll(){
    csvInput.value = '';
    uploadedRows = [];
    uploadedHeaders = [];
    fillMappingDropdowns([]);
    roster = [];
    tiers = { top: [], mid: [], bot: [], extra: [] };
    teams = [];
    renderRoster();
    renderTeams();
    setStatus('Cleared. Choose a Kahoot XLSX or paste CSV, then click Assign Roles.', 'warn');
  }

  function loadSample90(){
    const lines = ['name,score'];
    const first = ["Aaliyah","Brandon","Carlos","Dina","Evan","Fatima","Gabe","Hana","Imani","Jaden","Kiara","Luis","Maya","Nina","Omar","Priya","Quentin","Rosa","Sam","Tariq"];
    const last  = ["Johnson","Smith","Garcia","Martinez","Lee","Brown","Williams","Davis","Rodriguez","Wilson"];
    for (let i=1; i<=90; i++){
      const name = `${first[i % first.length]} ${last[(i * 3) % last.length]}`;
      const score = 5 + ((i * 7) % 16);
      lines.push(`${name},${score}`);
    }
    csvInput.value = lines.join('\n');
    setStatus('Sample (90 CSV) loaded. Click Assign Roles.', 'warn');
  }

  // ========= Wire up =========
  document.getElementById('assignRolesBtn').addEventListener('click', assignRoles);
  document.getElementById('shuffleBtn').addEventListener('click', shuffleRoles);
  document.getElementById('makeTeamsBtn').addEventListener('click', buildTeams);
  document.getElementById('exportCsvBtn').addEventListener('click', exportTeamsCSV);
  document.getElementById('copyTeamsBtn').addEventListener('click', copyTeams);
  document.getElementById('clearAll').addEventListener('click', clearAll);
  document.getElementById('loadSample').addEventListener('click', loadSample90);

  fileAny.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      await loadFile(file);
    } catch (err){
      console.error(err);
      setStatus('Could not read file. If XLSX, confirm it is a Kahoot report export.', 'err');
    }
  });

  [colName, colTotal, colAccuracy, colSpeed].forEach(sel => {
    sel.addEventListener('change', () => {
      if (uploadedHeaders.length){
        setStatus('Column mapping updated. Click Assign Roles to apply.', 'warn');
      }
    });
  });

  splitMode.addEventListener('change', () => {
    if (!roster.length) return;
    buildTiersFromRoster();
    tiers.top.forEach(s => s.role = 'Leader');
    tiers.mid.forEach(s => s.role = 'Designer');
    tiers.bot.forEach(s => s.role = 'Builder');
    tiers.extra.forEach(s => s.role = 'Extra');
    teams = [];
    renderRoster();
    renderTeams();
    setStatus('Split mode changed. Click Shuffle Roles (optional) then Build Teams.', 'warn');
  });

  // Initial
  fillMappingDropdowns([]);
  renderRoster();
  renderTeams();
</script>
</body>
</html>
