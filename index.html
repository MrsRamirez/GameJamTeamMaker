<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Jam Team Shuffler (Leader / Designer / Builder)</title>

  <style>
    /* =========================
       Purple/Fuchsia Theme
       ========================= */
    :root{
      --bg-0: #0b0612;
      --bg-1: #12081f;
      --card: rgba(255,255,255,0.06);
      --card-2: rgba(255,255,255,0.09);
      --border: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);

      --accent: #c026d3; /* fuchsia */
      --accent-2: #7c3aed; /* purple */
      --accent-3: #fb7185; /* rose-ish highlight */
      --good: rgba(34,197,94,0.18);
      --warn: rgba(245,158,11,0.18);
      --err: rgba(239,68,68,0.18);
      --shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    body{
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1100px 600px at 20% 10%, rgba(192,38,211,0.22), transparent 60%),
        radial-gradient(900px 520px at 80% 20%, rgba(124,58,237,0.22), transparent 60%),
        radial-gradient(900px 520px at 50% 90%, rgba(251,113,133,0.14), transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      min-height: 100vh;
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 40px;
    }

    header{
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    h1{
      margin: 0;
      font-size: clamp(22px, 3.2vw, 34px);
      letter-spacing: -0.02em;
      line-height: 1.05;
    }

    .subtitle{
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
      max-width: 70ch;
    }

    .badge{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    .badge b{ color: var(--text); font-weight: 650; }

    .row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .card h2{
      margin: 0 0 8px;
      font-size: 16px;
      letter-spacing: -0.01em;
    }

    .muted{ color: var(--muted); font-size: 13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    textarea{
      width: 100%;
      height: 190px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      padding: 12px;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    textarea:focus{
      border-color: rgba(192,38,211,0.55);
      box-shadow: 0 0 0 4px rgba(192,38,211,0.14);
    }

    input[type="text"], input[type="number"], select{
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 9px 10px;
      outline: none;
      min-height: 38px;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{
      border-color: rgba(124,58,237,0.6);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.16);
    }

    .controls{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }
    .controls > div{
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    button{
      border: 1px solid rgba(255,255,255,0.16);
      background: linear-gradient(135deg, rgba(192,38,211,0.92), rgba(124,58,237,0.92));
      color: white;
      border-radius: 12px;
      padding: 9px 12px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: 0.01em;
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
      transition: transform 0.05s ease, filter 0.2s ease, background 0.2s ease;
    }
    button:hover{ filter: brightness(1.07); }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: rgba(255,255,255,0.07);
      color: var(--text);
    }

    .status{
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      color: var(--muted);
    }
    .pill.ok{ background: var(--good); }
    .pill.warn{ background: var(--warn); }
    .pill.err{ background: var(--err); }

    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
    }
    th, td{
      padding: 9px 10px;
      font-size: 13px;
      border-bottom: 1px solid rgba(255,255,255,0.09);
    }
    th{
      text-align: left;
      color: rgba(255,255,255,0.88);
      background: rgba(255,255,255,0.06);
      font-weight: 750;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:last-child td{ border-bottom: none; }

    .role-grid{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .role-grid{ grid-template-columns: 1fr; }
    }
    .role-card{
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--card-2);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .role-title{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .role-title h3{
      margin: 0;
      font-size: 14px;
      letter-spacing: -0.01em;
    }
    .tag{
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.15);
      color: rgba(255,255,255,0.84);
      white-space: nowrap;
    }
    .role-card ul{
      margin: 8px 0 0 18px;
      color: rgba(255,255,255,0.85);
      font-size: 13px;
    }
    .role-card p{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .hint{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.14);
      color: var(--muted);
      font-size: 13px;
    }

    @media print{
      body{ background: white; color: #111; }
      .card{ box-shadow:none; background: white; border: 1px solid #ccc; }
      button, input, select, textarea, .hint, .badge { display:none !important; }
      th{ position: static; }
    }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <div>
        <h1>Game Jam Team Shuffler</h1>
        <div class="subtitle">
          Load student names + scores, rank automatically, split into <b>Leader / Designer / Builder</b>, shuffle within roles, and generate teams of 3.
          Works offline.
        </div>
      </div>
      <div class="badge">
        <span>Team formula:</span>
        <b>Leader + Designer + Builder</b>
      </div>
    </header>

    <div class="card">
      <h2>Student-Facing Role Descriptions</h2>
      <div class="muted">
        These labels are designed to reduce self-consciousness and emphasize that every role matters in game-making.
      </div>

      <div class="role-grid">
        <div class="role-card">
          <div class="role-title">
            <h3>Leader</h3>
            <span class="tag">Guides the team</span>
          </div>
          <ul>
            <li>Keep the team moving and on time</li>
            <li>Make sure everyone is heard</li>
            <li>Help the team decide what to try next</li>
          </ul>
          <p><b>Leaders do not</b> need to be the best coder or speaker.</p>
        </div>

        <div class="role-card">
          <div class="role-title">
            <h3>Designer</h3>
            <span class="tag">Shapes the experience</span>
          </div>
          <ul>
            <li>Think about the player’s experience</li>
            <li>Help shape rules, story, and choices</li>
            <li>Ask: “Does this make sense to a player?”</li>
          </ul>
          <p><b>Designers do not</b> need to be “good at art.”</p>
        </div>

        <div class="role-card">
          <div class="role-title">
            <h3>Builder</h3>
            <span class="tag">Makes it playable</span>
          </div>
          <ul>
            <li>Help turn ideas into a playable prototype</li>
            <li>Set up the game (paper or digital)</li>
            <li>Test things and notice what breaks</li>
          </ul>
          <p><b>Builders do not</b> need to know how to code.</p>
        </div>
      </div>

      <div class="hint">
        Tip you can say out loud: “Great games need all three roles. Today is about testing ideas, not perfection.”
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>1) Input (CSV)</h2>

        <div class="controls">
          <div>
            <label for="csvFile"><b>Upload CSV:</b></label>
            <input id="csvFile" type="file" accept=".csv,text/csv"/>
          </div>
          <div>
            <button class="secondary" id="loadSample">Load Sample (90)</button>
            <button class="secondary" id="clearAll">Clear</button>
          </div>
        </div>

        <p class="muted" style="margin:10px 0 6px;">
          CSV headers required: <span class="mono">name</span>, <span class="mono">score</span>.
          Optional: <span class="mono">id</span>, <span class="mono">grade</span>.
        </p>

        <textarea id="csvInput" placeholder="name,score,id,grade
Jane Doe,18,123456789,10
John Smith,12,987654321,11"></textarea>

        <div class="controls">
          <div>
            <label><b>Split mode:</b></label>
            <select id="splitMode">
              <option value="fixed30">Fixed 30 / 30 / 30</option>
              <option value="thirds">Automatic thirds</option>
            </select>
          </div>

          <div>
            <label><b>Seed (optional):</b></label>
            <input id="seedInput" type="text" placeholder="e.g., March6_2026"/>
          </div>

          <div>
            <label><b>Max teams:</b></label>
            <input id="maxTeams" type="number" min="1" max="60" value="30" style="width:92px;"/>
          </div>
        </div>

        <div class="controls">
          <button id="rankBtn">Rank</button>
          <button id="shuffleBtn">Shuffle</button>
          <button id="makeTeamsBtn">Make Teams</button>
        </div>

        <div class="status" id="status">
          <span class="pill warn">Paste/upload CSV, then click Rank.</span>
        </div>
      </div>

      <div class="card">
        <h2>2) Roster (Ranked)</h2>
        <div id="summary" class="muted">No roster yet.</div>
        <div id="rosterWrap"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h2>3) Teams</h2>
      <div class="muted">
        Teams generated as: <b>Leader + Designer + Builder</b> (after Shuffle). Extras remain unassigned.
      </div>

      <div class="controls" style="margin-top:10px;">
        <button id="exportCsvBtn">Export Teams CSV</button>
        <button id="copyTeamsBtn" class="secondary">Copy Teams</button>
        <button id="printBtn" class="secondary">Print</button>
      </div>

      <div id="teamsWrap"></div>
      <div id="extrasWrap" style="margin-top:10px;"></div>
    </div>

  </div>

<script>
  // ---------------------------
  // Robust CSV parsing (commas + quotes)
  // ---------------------------
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let field = '';
    let inQuotes = false;

    function endField() {
      row.push(field);
      field = '';
    }
    function endRow() {
      if (row.length === 1 && row[0].trim() === '') { row = []; return; }
      rows.push(row);
      row = [];
    }

    for (let i = 0; i < text.length; i++) {
      const c = text[i];

      if (c === '"') {
        if (inQuotes && text[i+1] === '"') {
          field += '"';
          i++;
          continue;
        }
        inQuotes = !inQuotes;
        continue;
      }
      if (!inQuotes && c === ',') { endField(); continue; }
      if (!inQuotes && c === '\n') { endField(); endRow(); continue; }
      if (!inQuotes && c === '\r') { continue; }

      field += c;
    }
    endField();
    endRow();

    if (!rows.length) return { headers: [], data: [] };

    const headers = rows[0].map(h => (h || '').trim().toLowerCase());
    const data = rows.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (r[idx] ?? '').trim());
      return obj;
    });
    return { headers, data };
  }

  function toNumberSafe(v) {
    const n = Number(String(v).trim());
    return Number.isFinite(n) ? n : null;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  // ---------------------------
  // Seeded RNG (optional)
  // ---------------------------
  function seedToUint32(seedStr) {
    if (!seedStr) return null;
    let h = 2166136261;
    for (let i = 0; i < seedStr.length; i++) {
      h ^= seedStr.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function mulberry32(a) {
    return function() {
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function shuffleInPlace(arr, rng) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(rng() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function downloadText(filename, text) {
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyToClipboard(text) {
    await navigator.clipboard.writeText(text);
  }

  // ---------------------------
  // State
  // ---------------------------
  let roster = []; // ranked full roster
  let tiers = { top: [], mid: [], bot: [], extra: [] }; // internal tiers
  let teams = [];

  // ---------------------------
  // DOM
  // ---------------------------
  const csvFile = document.getElementById('csvFile');
  const csvInput = document.getElementById('csvInput');
  const splitMode = document.getElementById('splitMode');
  const seedInput = document.getElementById('seedInput');
  const maxTeamsInput = document.getElementById('maxTeams');
  const statusEl = document.getElementById('status');
  const summaryEl = document.getElementById('summary');
  const rosterWrap = document.getElementById('rosterWrap');
  const teamsWrap = document.getElementById('teamsWrap');
  const extrasWrap = document.getElementById('extrasWrap');

  function setStatus(msg, kind) {
    const cls = kind === 'ok' ? 'ok' : (kind === 'err' ? 'err' : 'warn');
    statusEl.innerHTML = `<span class="pill ${cls}">${escapeHtml(msg)}</span>`;
  }

  // ---------------------------
  // Tiering logic
  // ---------------------------
  function buildTiersFromRoster() {
    tiers = { top: [], mid: [], bot: [], extra: [] };
    const mode = splitMode.value;
    const n = roster.length;

    if (mode === 'fixed30') {
      tiers.top = roster.slice(0, 30);
      tiers.mid = roster.slice(30, 60);
      tiers.bot = roster.slice(60, 90);
      tiers.extra = roster.slice(90);
      return;
    }

    // Automatic thirds as equal as possible
    const base = Math.floor(n / 3);
    const remainder = n - base * 3;

    const topSize = base + (remainder >= 1 ? 1 : 0);
    const midSize = base + (remainder >= 2 ? 1 : 0);
    const botSize = base;

    tiers.top = roster.slice(0, topSize);
    tiers.mid = roster.slice(topSize, topSize + midSize);
    tiers.bot = roster.slice(topSize + midSize, topSize + midSize + botSize);
    tiers.extra = roster.slice(topSize + midSize + botSize);
  }

  function annotateTierForDisplay() {
    const key = (s) => s.id ? `id:${s.id}` : `name:${s.name}|score:${s.score}|rank:${s.rank}`;
    const topSet = new Set(tiers.top.map(key));
    const midSet = new Set(tiers.mid.map(key));
    const botSet = new Set(tiers.bot.map(key));
    const extraSet = new Set(tiers.extra.map(key));

    roster = roster.map(s => {
      const k = key(s);
      let tier = '';
      if (topSet.has(k)) tier = 'Leader';
      else if (midSet.has(k)) tier = 'Designer';
      else if (botSet.has(k)) tier = 'Builder';
      else if (extraSet.has(k)) tier = 'Extra';
      return { ...s, tier };
    });
  }

  // ---------------------------
  // Rendering
  // ---------------------------
  function renderRoster() {
    if (!roster.length) {
      summaryEl.textContent = 'No roster yet.';
      rosterWrap.innerHTML = '<p class="muted">Paste or upload CSV and click Rank.</p>';
      return;
    }

    const possibleTeams = Math.min(tiers.top.length, tiers.mid.length, tiers.bot.length);
    summaryEl.innerHTML = `
      Students ranked: <b>${roster.length}</b> |
      Leaders: <b>${tiers.top.length}</b>,
      Designers: <b>${tiers.mid.length}</b>,
      Builders: <b>${tiers.bot.length}</b>,
      Extra: <b>${tiers.extra.length}</b> |
      Possible teams: <b>${possibleTeams}</b>
    `;

    const rows = roster.slice(0, 120).map(s => `
      <tr>
        <td>${s.rank}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.id || '')}</td>
        <td>${escapeHtml(s.grade || '')}</td>
        <td>${s.score}</td>
        <td>${escapeHtml(s.tier || '')}</td>
      </tr>
    `).join('');

    rosterWrap.innerHTML = `
      <table>
        <thead>
          <tr><th>Rank</th><th>Name</th><th>ID</th><th>Grade</th><th>Score</th><th>Role</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="muted">Showing first 120 ranked students.</div>
    `;
  }

  function renderTeams() {
    if (!teams.length) {
      teamsWrap.innerHTML = '<p class="muted">No teams yet. Click Shuffle (optional) then Make Teams.</p>';
      extrasWrap.innerHTML = '';
      return;
    }

    const rows = teams.map(t => `
      <tr>
        <td>${t.team}</td>
        <td>${escapeHtml(t.leader.name)} <span class="pill">${escapeHtml(t.leader.grade || '')}</span></td>
        <td>${escapeHtml(t.designer.name)} <span class="pill">${escapeHtml(t.designer.grade || '')}</span></td>
        <td>${escapeHtml(t.builder.name)} <span class="pill">${escapeHtml(t.builder.grade || '')}</span></td>
      </tr>
    `).join('');

    teamsWrap.innerHTML = `
      <table>
        <thead><tr><th>Team</th><th>Leader</th><th>Designer</th><th>Builder</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    const teamCount = teams.length;
    const unassigned = [
      ...tiers.top.slice(teamCount).map(s => ({...s, _role:'Leader'})),
      ...tiers.mid.slice(teamCount).map(s => ({...s, _role:'Designer'})),
      ...tiers.bot.slice(teamCount).map(s => ({...s, _role:'Builder'})),
      ...tiers.extra.map(s => ({...s, _role:'Extra'}))
    ];

    if (!unassigned.length) {
      extrasWrap.innerHTML = `<div class="muted"><b>Unassigned:</b> none</div>`;
    } else {
      const list = unassigned.slice(0, 60).map(s =>
        `<li>${escapeHtml(s.name)} <span class="pill">${escapeHtml(s._role)}</span> <span class="muted">${escapeHtml(s.grade||'')}</span></li>`
      ).join('');
      extrasWrap.innerHTML = `
        <div class="muted"><b>Unassigned students:</b> ${unassigned.length} (showing up to 60)</div>
        <ul>${list}</ul>
      `;
    }
  }

  // ---------------------------
  // Actions
  // ---------------------------
  async function loadFileToTextarea(file) {
    const text = await file.text();
    csvInput.value = text;
    setStatus(`Loaded ${file.name}. Click Rank.`, 'warn');
  }

  function rankStudents() {
    const { headers, data } = parseCSV(csvInput.value || '');

    if (!headers.includes('name') || !headers.includes('score')) {
      setStatus('CSV must include headers: name, score (optional: id, grade).', 'err');
      return;
    }

    const cleaned = [];
    for (const d of data) {
      const name = (d.name || '').trim();
      const score = toNumberSafe(d.score);
      if (!name || score === null) continue;

      cleaned.push({
        name,
        score,
        id: (d.id || '').trim(),
        grade: (d.grade || '').trim()
      });
    }

    if (cleaned.length < 3) {
      setStatus('Need at least 3 valid rows with name + numeric score.', 'err');
      return;
    }

    cleaned.sort((a, b) => (b.score - a.score) || a.name.localeCompare(b.name));

    roster = cleaned.map((s, idx) => ({
      ...s,
      rank: idx + 1,
      tier: ''
    }));

    buildTiersFromRoster();
    annotateTierForDisplay();

    teams = [];
    renderRoster();
    renderTeams();

    const possibleTeams = Math.min(tiers.top.length, tiers.mid.length, tiers.bot.length);
    setStatus(`Ranked ${roster.length} students. Possible teams: ${possibleTeams}.`, 'ok');
  }

  function shuffleTiers() {
    if (!roster.length) { setStatus('Rank students first.', 'warn'); return; }

    buildTiersFromRoster();

    const seed = seedToUint32(seedInput.value.trim());
    const rng = seed === null ? Math.random : mulberry32(seed);

    shuffleInPlace(tiers.top, rng);
    shuffleInPlace(tiers.mid, rng);
    shuffleInPlace(tiers.bot, rng);

    annotateTierForDisplay();
    teams = [];
    renderRoster();
    renderTeams();

    setStatus('Shuffled roles. Click Make Teams.', 'ok');
  }

  function makeTeams() {
    if (!roster.length) { setStatus('Rank students first.', 'warn'); return; }

    const possibleTeams = Math.min(tiers.top.length, tiers.mid.length, tiers.bot.length);
    const maxTeams = Math.max(1, Math.min(Number(maxTeamsInput.value || 30), 60));
    const teamCount = Math.min(possibleTeams, maxTeams);

    if (teamCount < 1) {
      setStatus('Not enough students in roles to form teams.', 'err');
      teams = [];
      renderTeams();
      return;
    }

    teams = [];
    for (let i = 0; i < teamCount; i++) {
      teams.push({
        team: i + 1,
        leader: tiers.top[i],
        designer: tiers.mid[i],
        builder: tiers.bot[i]
      });
    }

    renderTeams();
    setStatus(`Created ${teams.length} teams.`, 'ok');
  }

  function exportTeamsCSV() {
    if (!teams.length) { setStatus('Generate teams first.', 'warn'); return; }

    const lines = [];
    lines.push('team,leader_name,leader_id,leader_grade,designer_name,designer_id,designer_grade,builder_name,builder_id,builder_grade');
    for (const t of teams) {
      lines.push([
        t.team,
        csvCell(t.leader.name), csvCell(t.leader.id), csvCell(t.leader.grade),
        csvCell(t.designer.name), csvCell(t.designer.id), csvCell(t.designer.grade),
        csvCell(t.builder.name), csvCell(t.builder.id), csvCell(t.builder.grade)
      ].join(','));
    }
    downloadText('gamejam_teams.csv', lines.join('\n'));
    setStatus('Exported teams CSV.', 'ok');
  }

  function csvCell(v) {
    const s = String(v ?? '');
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  async function copyTeams() {
    if (!teams.length) { setStatus('Generate teams first.', 'warn'); return; }
    const text = teams.map(t => `Team ${t.team}: ${t.leader.name} | ${t.designer.name} | ${t.builder.name}`).join('\n');
    try {
      await copyToClipboard(text);
      setStatus('Copied teams to clipboard.', 'ok');
    } catch {
      setStatus('Could not copy (browser permission). Try Export CSV instead.', 'warn');
    }
  }

  function clearAll() {
    csvInput.value = '';
    roster = [];
    tiers = { top: [], mid: [], bot: [], extra: [] };
    teams = [];
    renderRoster();
    renderTeams();
    setStatus('Cleared. Paste/upload CSV, then click Rank.', 'warn');
  }

  function loadSample90() {
    const lines = ['name,score,id,grade'];
    const first = ["Aaliyah","Brandon","Carlos","Dina","Evan","Fatima","Gabe","Hana","Imani","Jaden","Kiara","Luis","Maya","Nina","Omar","Priya","Quentin","Rosa","Sam","Tariq"];
    const last = ["Johnson","Smith","Garcia","Martinez","Lee","Brown","Williams","Davis","Rodriguez","Wilson"];
    let idBase = 100000000;
    for (let i = 1; i <= 90; i++) {
      const name = `${first[i % first.length]} ${last[(i * 3) % last.length]}`;
      const score = 5 + ((i * 7) % 16); // 5..20
      const id = idBase + i;
      const grade = [10,11,12][i % 3];
      lines.push(`${name},${score},${id},${grade}`);
    }
    csvInput.value = lines.join('\n');
    setStatus('Sample (90) loaded. Click Rank.', 'warn');
  }

  // ---------------------------
  // Wire up events
  // ---------------------------
  document.getElementById('rankBtn').addEventListener('click', rankStudents);
  document.getElementById('shuffleBtn').addEventListener('click', shuffleTiers);
  document.getElementById('makeTeamsBtn').addEventListener('click', makeTeams);
  document.getElementById('exportCsvBtn').addEventListener('click', exportTeamsCSV);
  document.getElementById('copyTeamsBtn').addEventListener('click', copyTeams);
  document.getElementById('printBtn').addEventListener('click', () => window.print());
  document.getElementById('clearAll').addEventListener('click', clearAll);
  document.getElementById('loadSample').addEventListener('click', loadSample90);

  csvFile.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (file) loadFileToTextarea(file);
  });

  splitMode.addEventListener('change', () => {
    if (!roster.length) return;
    buildTiersFromRoster();
    annotateTierForDisplay();
    teams = [];
    renderRoster();
    renderTeams();
    setStatus('Split mode changed. Click Shuffle (optional) then Make Teams.', 'warn');
  });

  // Initial render
  renderRoster();
  renderTeams();
</script>
</body>
</html>
